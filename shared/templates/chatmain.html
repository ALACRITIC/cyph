<div
	class='chat-main layout-column layout-fill flex'
	[class.video]='self.p2pManager.p2p.isActive'
	[class.mobile]='self.isMobile'
	*ngIf='cyph && self'
>
	<div
		class='cyph-view loading layout-column layout-fill flex'
		[class.active]='self.state === cyph.UI.Chat.States.keyExchange'
	>
		<div class='flex'></div>
		<div class='logo-animation'>
			<div></div>
			<div></div>
			<div></div>
			<div></div>
			<div></div>
		</div>
		<div cyphTranslate>Initiating key exchange...</div>
		<md2-progress-linear
			childClass='md-accent key-exchange-progress'
			mdMode='determinate'
			[value]='self.keyExchangeProgress'
		></md2-progress-linear>
		<div class='flex'></div>
	</div>

	<div
		class='cyph-view abort-screen loading layout-column layout-fill flex'
		[class.active]='self.state === cyph.UI.Chat.States.aborted'
	>
		<div class='flex'></div>
		<div class='image'>
			<img src='/img/walken.png' alt='Definitely not Christopher Walken' cyphTranslate />
		</div>
		<div>
			<div cyphTranslate>This cyph has been aborted.</div>
			<br />
			<span cyphTranslate>Please</span>
			<a
				cyphTranslate
				target='_self'
				[href]='cyph.Env.newCyphUrl'
			>try again</a>.
		</div>
		<div class='flex'></div>
	</div>

	<div
		class='cyph-view chat-begin-message loading layout-column layout-fill flex'
		[class.active]='self.state === cyph.UI.Chat.States.chatBeginMessage'
	>
		<div class='flex'></div>
		<div class='logo-animation connected'></div>
		<div cyphTranslate>Securely Connected!</div>
		<md2-progress-linear
			childClass='md-accent key-exchange-progress'
			mdMode='determinate'
			[value]='100'
		></md2-progress-linear>
		<div class='flex'></div>
	</div>

	<div
		class='cyph-view video-call flex'
		[class.active]='self.state === cyph.UI.Chat.States.chat'
		[class.playing]='self.p2pManager.p2p.isActive'
		[class.sidebar-open]='self.p2pManager.isSidebarOpen'
	>
		<a class='logo' rel='noreferrer' [href]='cyph.Env.homeUrl'>
			<img src='/img/betalogo.mobile.png' alt='Beta logo' cyphTranslate />
		</a>
		<div
			class='friend stream'
			*ngIf='
				self.p2pManager.p2p.incomingStream.video &&
				!self.p2pManager.p2p.loading
			'
		></div>
		<img
			class='friend'
			*ngIf='!(
				self.p2pManager.p2p.incomingStream.video ||
				self.p2pManager.p2p.loading
			)'
			src='/img/voicecall.jpg'
		/>
		<video
			class='me'
			*ngIf='self.p2pManager.p2p.outgoingStream.video'
			autoplay
			muted
		></video>

		<md2-progress-circular
			*ngIf='self.p2pManager.p2p.loading'
			mdMode='indeterminate'
		></md2-progress-circular>

		<md2-button
			cyphTranslate
			childClass='sidebar'
			ariaLabel='Sidebar'
			(childClick)='self.p2pManager.toggleSidebar()'
		>
			<img src='/img/icons/chat.png' alt='Chat' cyphTranslate />
		</md2-button>

		<div class='buttons'>
			<md2-button
				cyphTranslate
				childClass='md-fab video-call-button'
				(childClick)='self.p2pManager.videoCallButton()'
				[ariaLabel]='
					!self.p2pManager.p2p.outgoingStream.video ?
						"Enable Camera" :
						"Disable Camera"
				'
			>
				<img
					cyphTranslate
					*ngIf='!self.p2pManager.p2p.outgoingStream.video'
					src='/img/icons/video.on.png'
					alt='Video on'
				/>
				<img
					cyphTranslate
					*ngIf='self.p2pManager.p2p.outgoingStream.video'
					src='/img/icons/video.off.png'
					alt='Video off'
				/>
			</md2-button>
			<md2-button
				cyphTranslate
				childClass='md-fab voice-call-button'
				(childClick)='self.p2pManager.voiceCallButton()'
				[ariaLabel]='
					!self.p2pManager.p2p.outgoingStream.audio ?
						"Enable Mic" :
						"Disable Mic"
				'
			>
				<img
					cyphTranslate
					*ngIf='!self.p2pManager.p2p.outgoingStream.audio'
					src='/img/icons/mic.on.png'
					alt='Mic on'
				/>
				<img
					cyphTranslate
					*ngIf='self.p2pManager.p2p.outgoingStream.audio'
					src='/img/icons/mic.off.png'
					alt='Mic off'
				/>
			</md2-button>
			<md2-button
				cyphTranslate
				ariaLabel='End Call'
				childClass='md-fab md-theme-grey close-button'
				(childClick)='self.p2pManager.closeButton()'
			>
				<md2-icon>call_end</md2-icon>
			</md2-button>
		</div>
	</div>

	<cyph-chat-message-box
		class='video-call-message-box'
		[self]='self'
	></cyph-chat-message-box>

	<div
		class='cyph-view transfer-list flex'
		[class.active]='self.state === cyph.UI.Chat.States.chat'
	>
		<md2-content childClass='md-no-flicker'>
			<md2-list childClass='layout-column'>
				<md2-list-item
					childClass='transfer layout-row'
					*ngFor='let transfer of self.fileManager.files.transfers'
				>
					<div class='layout-column layout-align-start-stretch flex'>
						<div class='layout-row'>
							<span *ngIf='transfer.isOutgoing' cyphTranslate>Sending</span>
							<span *ngIf='!transfer.isOutgoing' cyphTranslate>Receiving</span>
							&nbsp;
							<span>
								{{transfer.name}}
								({{cyph.Util.readableByteLength(transfer.size)}}):
							</span>
						</div>
						<md2-progress-linear
							mdMode='determinate'
							[value]='transfer.percentComplete'
							childClass='layout-row'
						></md2-progress-linear>
					</div>
				</md2-list-item>
			</md2-list>
		</md2-content>
	</div>

	<div
		class='cyph-view message-list nano flex'
		[class.active]='self.state === cyph.UI.Chat.States.chat'
		[style.margin-top]='
			(
				(
					self.fileManager.files.transfers.length < 3 ?
						self.fileManager.files.transfers.length :
						3
				) * 55
			) + "px"
		'
	>
		<md2-content childClass='nano-content md-no-flicker'>
			<md2-list childClass='layout-column'>
				<md2-list-item
					[childClass]='
						"message-item unread layout-row" +
						(
							" author-" + (
								cyph.Session.Users[message.author] ||
								cyph.Session.Users.other
							)
						) +
						(
							message.selfDestructTimer && message.selfDestructTimer.isComplete ?
								" self-destructed" :
								""
						)
					'
					*ngFor='let message of self.messages'
				>
					<div class='flex layout-column'>
						<div class='layout-row'>
							<span class='message'>
								<strong
									class='message-author'
									*ngIf='message.author === cyph.Session.Users.me'
								>
									{{cyph.Strings.me}}:
								</strong>
								<strong
									class='message-author'
									*ngIf='
										message.author !== cyph.Session.Users.me &&
										message.author !== cyph.Session.Users.app
									'
								>
									{{message.author}}:
								</strong>
								<cyph-markdown
									class='message-text'
									[markdown]='message.text'
									[class.app-message]='message.author === cyph.Session.Users.app'
								></cyph-markdown>
							</span>
							<span class='message-timestamp flex'>
								<span *ngIf='
									(self.isMobile || self.p2pManager.p2p.isActive) &&
									message.author === cyph.Session.Users.me
								'>
									{{cyph.Strings.me}} &nbsp;&mdash;&nbsp;
								</span>

								{{message.timeString}}

								<span *ngIf='
									(self.isMobile || self.p2pManager.p2p.isActive) &&
									message.author !== cyph.Session.Users.me &&
									message.author !== cyph.Session.Users.app
								'>
									&nbsp;&mdash;&nbsp; {{message.author}}
								</span>
							</span>
						</div>
						<div
							class='self-destruct-timer layout-row'
							*ngIf='message.selfDestructTimer'
						>
							<span cyphTranslate>Message will self-destruct in</span>
							<span class='countdown'>{{message.selfDestructTimer.timestamp}}</span>
						</div>
					</div>
					<div class='self-destruct-cover'></div>
				</md2-list-item>

				<md2-list-item
					[childClass]='
						"friend-is-typing layout-row" +
						(self.isFriendTyping ? " show" : "")
					'
				>
					<span class='ellipsis-spinner'>
						<div class='bounce1'></div>
						<div class='bounce2'></div>
						<div class='bounce3'></div>
					</span>
				</md2-list-item>

				<md2-list-item
					childClass='chat-end-message layout-row layout-align-center-center'
					*ngIf='self.isDisconnected && !hideDisconnectMessage'
				>
					<md2-card childClass='md-padding flex-75 flex-gt-sm-50'>
						<md2-card-content>
							<ng-content></ng-content>
						</md2-card-content>
					</md2-card>
				</md2-list-item>
			</md2-list>
		</md2-content>
	</div>
</div>
